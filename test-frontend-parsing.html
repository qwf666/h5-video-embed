<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•çº¯å‰ç«¯ B ç«™è§£æ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-item {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        .success {
            border-color: #28a745;
            background: #f8fff8;
        }
        .error {
            border-color: #dc3545;
            background: #fff8f8;
        }
        .loading {
            border-color: #ffc107;
            background: #fffef8;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .status {
            font-weight: bold;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ çº¯å‰ç«¯ B ç«™è§£ææµ‹è¯•</h1>
        <p>æ­¤æµ‹è¯•éªŒè¯åœ¨ä¸è°ƒç”¨åç«¯ API çš„æƒ…å†µä¸‹è§£æ B ç«™è§†é¢‘</p>
        
        <div id="test-results"></div>
        
        <div style="margin-top: 20px;">
            <button onclick="runAllTests()">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
            <button onclick="clearResults()">æ¸…ç©ºç»“æœ</button>
        </div>
    </div>

    <script type="module">
        // ç®€åŒ–çš„ BilibiliParser æµ‹è¯•ç‰ˆæœ¬
        class SimpleBilibiliParser {
            constructor(options = {}) {
                this.strictFrontendOnly = options.strictFrontendOnly || false;
            }

            async parse(url) {
                const extractResult = this.extractBvid(url);
                if (!extractResult) {
                    throw new Error('æ— æ•ˆçš„Bç«™é“¾æ¥');
                }

                console.log(`ğŸ“º æ£€æµ‹åˆ°Bç«™å†…å®¹: ${JSON.stringify(extractResult)}`);

                // ä¸¥æ ¼å‰ç«¯æ¨¡å¼ä¸‹ç›´æ¥è¿”å›åŸºç¡€ä¿¡æ¯ï¼Œä¸å°è¯•APIè°ƒç”¨
                if (this.strictFrontendOnly) {
                    console.log('âš¡ ä¸¥æ ¼å‰ç«¯æ¨¡å¼ï¼šç›´æ¥è¿”å›åŸºç¡€è§£æä¿¡æ¯');
                    return this.createFallbackData(extractResult, url);
                }

                // å°è¯•è°ƒç”¨Bç«™API
                try {
                    if (extractResult.type === 'video') {
                        const videoInfo = await this.getVideoInfo(extractResult.id);
                        return this.formatVideoData(videoInfo, url, extractResult);
                    }
                    // å…¶ä»–ç±»å‹æš‚æ—¶è¿”å›åŸºç¡€ä¿¡æ¯
                    return this.createFallbackData(extractResult, url);
                } catch (error) {
                    console.warn('APIè°ƒç”¨å¤±è´¥ï¼Œè¿”å›åŸºç¡€ä¿¡æ¯:', error.message);
                    return this.createFallbackData(extractResult, url);
                }
            }

            async getVideoInfo(bvid) {
                const apiUrl = `https://api.bilibili.com/x/web-interface/view?bvid=${bvid}`;
                
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
                        'Referer': 'https://www.bilibili.com/',
                        'Origin': 'https://www.bilibili.com'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Bç«™APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.code !== 0) {
                    throw new Error(`Bç«™APIé”™è¯¯: ${result.message}`);
                }

                return result.data;
            }

            formatVideoData(data, originalUrl, extractResult) {
                return {
                    id: data.bvid,
                    title: data.title,
                    description: data.desc || '',
                    thumbnail: data.pic,
                    uploader: data.owner?.name || 'æœªçŸ¥ç”¨æˆ·',
                    view_count: data.stat?.view || 0,
                    like_count: data.stat?.like || 0,
                    duration: data.duration,
                    webpage_url: originalUrl,
                    platform: 'bilibili',
                    platform_name: 'Bç«™',
                    extractor: 'bilibili_frontend',
                    content_type: 'video',
                    embed: {
                        type: 'iframe',
                        url: `https://player.bilibili.com/player.html?bvid=${data.bvid}&autoplay=0`,
                        width: 1280,
                        height: 720
                    }
                };
            }

            createFallbackData(extractResult, originalUrl) {
                const id = extractResult.id;
                return {
                    id: id,
                    title: `Bç«™${extractResult.type}å†…å®¹ - ${id}`,
                    description: 'çº¯å‰ç«¯è§£ææ¨¡å¼ï¼šéƒ¨åˆ†ä¿¡æ¯å¯èƒ½ä¸å®Œæ•´',
                    thumbnail: 'https://i0.hdslb.com/bfs/archive/default.jpg',
                    webpage_url: originalUrl,
                    platform: 'bilibili',
                    platform_name: 'Bç«™',
                    extractor: 'bilibili_frontend_fallback',
                    content_type: extractResult.type,
                    is_fallback: true,
                    fallback_reason: 'çº¯å‰ç«¯æ¨¡å¼ï¼Œæœªè°ƒç”¨ä»»ä½•åç«¯æ¥å£',
                    supports_embed: true,
                    embed: {
                        type: 'iframe',
                        url: `https://player.bilibili.com/player.html?bvid=${id}&autoplay=0`,
                        width: 1280,
                        height: 720
                    }
                };
            }

            extractBvid(url) {
                const patterns = [
                    /(?:bilibili\.com\/video\/|b23\.tv\/)(BV[a-zA-Z0-9]+)/i,
                    /(?:bilibili\.com\/video\/|b23\.tv\/)(av\d+)/i,
                    /(?:bilibili\.com\/bangumi\/play\/)(ep\d+)/i,
                    /(?:bilibili\.com\/bangumi\/play\/)(ss\d+)/i,
                    /(?:live\.bilibili\.com\/)(h5\/)?(\d+)/i
                ];
                
                for (const pattern of patterns) {
                    const match = url.match(pattern);
                    if (match) {
                        let id = match[1] || match[2];
                        
                        if (id.startsWith('ep') || id.startsWith('ss')) {
                            return { type: 'bangumi', id: id };
                        }
                        
                        if (/^\d+$/.test(id)) {
                            return { type: 'live', id: id };
                        }
                        
                        return { type: 'video', id: id };
                    }
                }
                
                return null;
            }
        }

        // æµ‹è¯•ç”¨ä¾‹
        const testCases = [
            {
                name: 'æ ‡å‡† BV å·è§†é¢‘ï¼ˆä¸¥æ ¼å‰ç«¯æ¨¡å¼ï¼‰',
                url: 'https://www.bilibili.com/video/BV1A1hXzHEou',
                strictFrontendOnly: true,
                expectedNoApiCall: true
            },
            {
                name: 'æ ‡å‡† BV å·è§†é¢‘ï¼ˆå…è®¸ API è°ƒç”¨ï¼‰',
                url: 'https://www.bilibili.com/video/BV1A1hXzHEou',
                strictFrontendOnly: false,
                expectedNoApiCall: false
            },
            {
                name: 'åˆ†Pè§†é¢‘ï¼ˆä¸¥æ ¼å‰ç«¯æ¨¡å¼ï¼‰',
                url: 'https://www.bilibili.com/video/BV1A1hXzHEou?p=2',
                strictFrontendOnly: true,
                expectedNoApiCall: true
            },
            {
                name: 'ç•ªå‰§é“¾æ¥ï¼ˆä¸¥æ ¼å‰ç«¯æ¨¡å¼ï¼‰',
                url: 'https://www.bilibili.com/bangumi/play/ep123456',
                strictFrontendOnly: true,
                expectedNoApiCall: true
            }
        ];

        // æµ‹è¯•è¿è¡Œå™¨
        window.runAllTests = async function() {
            const resultsContainer = document.getElementById('test-results');
            resultsContainer.innerHTML = '';

            for (let i = 0; i < testCases.length; i++) {
                const testCase = testCases[i];
                await runSingleTest(testCase, i + 1);
            }
        };

        async function runSingleTest(testCase, index) {
            const resultsContainer = document.getElementById('test-results');
            
            // åˆ›å»ºæµ‹è¯•é¡¹ç›®å®¹å™¨
            const testDiv = document.createElement('div');
            testDiv.className = 'test-item loading';
            testDiv.innerHTML = `
                <div class="status">æµ‹è¯• ${index}: ${testCase.name}</div>
                <div>URL: ${testCase.url}</div>
                <div>ä¸¥æ ¼å‰ç«¯æ¨¡å¼: ${testCase.strictFrontendOnly ? 'æ˜¯' : 'å¦'}</div>
                <div>æµ‹è¯•ä¸­...</div>
            `;
            resultsContainer.appendChild(testDiv);

            try {
                const parser = new SimpleBilibiliParser({ 
                    strictFrontendOnly: testCase.strictFrontendOnly 
                });

                // è®°å½•å¼€å§‹æ—¶é—´å’Œç½‘ç»œè¯·æ±‚
                const startTime = Date.now();
                let apiCallMade = false;

                // ç›‘å¬ç½‘ç»œè¯·æ±‚ï¼ˆç®€å•æ£€æµ‹ï¼‰
                const originalFetch = window.fetch;
                window.fetch = function(...args) {
                    if (args[0].includes('api.bilibili.com')) {
                        apiCallMade = true;
                        console.log('ğŸŒ æ£€æµ‹åˆ°Bç«™APIè°ƒç”¨:', args[0]);
                    }
                    return originalFetch.apply(this, args);
                };

                const result = await parser.parse(testCase.url);
                const endTime = Date.now();

                // æ¢å¤åŸå§‹fetch
                window.fetch = originalFetch;

                // éªŒè¯ç»“æœ
                const success = testCase.expectedNoApiCall ? !apiCallMade : true;
                
                testDiv.className = success ? 'test-item success' : 'test-item error';
                testDiv.innerHTML = `
                    <div class="status">æµ‹è¯• ${index}: ${testCase.name} - ${success ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}</div>
                    <div>URL: ${testCase.url}</div>
                    <div>ä¸¥æ ¼å‰ç«¯æ¨¡å¼: ${testCase.strictFrontendOnly ? 'æ˜¯' : 'å¦'}</div>
                    <div>æ˜¯å¦è°ƒç”¨API: ${apiCallMade ? 'æ˜¯' : 'å¦'}</div>
                    <div>è§£ææ—¶é—´: ${endTime - startTime}ms</div>
                    <div>è§£æç»“æœ:</div>
                    <pre>${JSON.stringify({
                        id: result.id,
                        title: result.title,
                        platform: result.platform_name,
                        extractor: result.extractor,
                        is_fallback: result.is_fallback,
                        supports_embed: result.supports_embed
                    }, null, 2)}</pre>
                `;

                if (!success) {
                    console.error(`æµ‹è¯•å¤±è´¥: ${testCase.name}`, {
                        expected: `APIè°ƒç”¨=${!testCase.expectedNoApiCall}`,
                        actual: `APIè°ƒç”¨=${apiCallMade}`
                    });
                }

            } catch (error) {
                testDiv.className = 'test-item error';
                testDiv.innerHTML = `
                    <div class="status">æµ‹è¯• ${index}: ${testCase.name} - âŒ å¼‚å¸¸</div>
                    <div>URL: ${testCase.url}</div>
                    <div>é”™è¯¯: ${error.message}</div>
                `;
                console.error(`æµ‹è¯•å¼‚å¸¸: ${testCase.name}`, error);
            }
        }

        window.clearResults = function() {
            document.getElementById('test-results').innerHTML = '';
        };

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿è¡Œæµ‹è¯•
        window.addEventListener('load', () => {
            console.log('ğŸš€ å¼€å§‹çº¯å‰ç«¯Bç«™è§£ææµ‹è¯•');
            setTimeout(runAllTests, 1000);
        });
    </script>
</body>
</html>
